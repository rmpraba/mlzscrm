

<link rel="import" href="..\..\bower_components/polymer/polymer.html">

<dom-module id="duereport-service">
  <template>
        <iron-ajax
        method="post"
        id="processreportajax"
        url="{{processreporturl}}"
        params="{{processreportparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="processreportResponse"
        debounce-duration="300"
        >
        <iron-ajax
        method="post"
        id="fetchallstudentstructureajax"
        url="{{fetchallstudentstructureurl}}"
        params="{{fetchallstudentstructureparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="fetchallstudentstructureResponse"
        debounce-duration="300"
        > 
        <iron-ajax
        method="post"
        id="insertduereportstructureajax"
        url="{{insertduereportstructureurl}}"
        params="{{insertduereportstructureparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="insertduereportstructureResponse"
        debounce-duration="300"
        >
        <iron-ajax
        method="post"
        id="duereportupdatepaidfeeajax"
        url="{{duereportupdatepaidfeeurl}}"
        params="{{duereportupdatepaidfeeparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="duereportupdatepaidfeeResponse"
        debounce-duration="300"
        >
        <iron-ajax
        method="post"
        id="duereportactualfeeupdateajax"
        url="{{duereportactualfeeupdateurl}}"
        params="{{duereportactualfeeupdateparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="duereportactualfeeupdateResponse"
        debounce-duration="300"
        >
        <iron-ajax
        method="post"
        id="duereportdueupdateajax"
        url="{{duereportdueupdateurl}}"
        params="{{duereportdueupdateparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="duereportdueupdateResponse"
        debounce-duration="300"
        >  
        <iron-ajax
        method="post"
        id="duereportdiscountupdateajax"
        url="{{duereportdiscountupdateurl}}"
        params="{{duereportdiscountupdateparam}}"
        handle-as="json"
        content-type="application/json"
        on-response="duereportdiscountupdateResponse"
        debounce-duration="300"
        >    
  </template>
  <script>
  (function() {
    'use strict';
     var count1=0;
     var count2=0;
     var cnt1=0;
     var cnt2=0;
     var c1=0;
     var c2=0;
    Polymer({
      is: 'duereport-service',

      FnFetchAllStudentStructureService:function(academicyear,grade){
        this.fetchallstudentstructureurl=sessionStorage.getItem("addrinfo")+"/fetchallstudentstructure-service";
        var obj={"schoolid":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.academicyear=academicyear;
        obj.grade=grade;
        this.fetchallstudentstructureparam=obj;
        this.$.fetchallstudentstructureajax.generateRequest();
      },
      fetchallstudentstructureResponse:function(e){
        var structure=e.detail.response.structure;
        var group=e.detail.response.group;
        // alert(JSON.stringify(structure));
        // alert(JSON.stringify(group));
        this.structarr=[];
        for(var i=0;i<structure.length;i++){
          var obj={};
          var total=0;
          for(var j=0;j<group.length;j++){            
            if(structure[i].fee_code==group[j].fee_code)
            {
              obj.academicyear=structure[i].academic_year;
              obj.admissionyear=structure[i].admission_year;
              obj.grade=structure[i].grade;
              var x=(group[j].fee_type).replace(' ','');
              obj[x]=group[j].amount;
              total=parseFloat(total)+parseFloat(group[j].amount);
              obj.total=total;
            }
          }
          this.structarr.push(obj);
        }
      },
      FnProcessReportService:function(academicyear,grade,type){
        this.processreporturl=sessionStorage.getItem("addrinfo")+"/processreport-service";
        var obj={"schoolid":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.academicyear=academicyear;
        obj.grade=grade;
        obj.type=type;
        this.processreportparam=obj;
        this.$.processreportajax.generateRequest();
      },
      processreportResponse:function(e){
        var totalarr=e.detail.response.totalarr;
        this.totalarr=e.detail.response.totalarr;
        this.paidarr=e.detail.response.paidarr;
        this.inssplit=e.detail.response.inssplit;
        this.feesplit1=e.detail.response.feesplit;
        this.feesplit=e.detail.response.feesplit;
        // var feesplit1=e.detail.response.feesplit;
        // alert(JSON.stringify(feesplit));
        var bindarr=[];
        for(var i=0;i<totalarr.length;i++){
          for(var j=0;j<this.structarr.length;j++){
            var obj={};
            var flag=0;
          if(totalarr[i].academic_year==this.structarr[j].academicyear&&totalarr[i].admission_year==this.structarr[j].admissionyear&&totalarr[i].class_for_admission==this.structarr[j].grade){
              flag=1;
              obj.admission_no=totalarr[i].admission_no;
              obj.student_name=totalarr[i].student_name;
              obj.grade=totalarr[i].class_for_admission;
              obj.father_name=totalarr[i].father_name;
              obj.admission_status=totalarr[i].admission_status;
              obj.kitfee=this.structarr[j].Kitfee;
              obj.annualfee=this.structarr[j].Annualfee;
              obj.tutionfee=this.structarr[j].Tutionfee;
              obj.total=this.structarr[j].total;        
            }
            if(flag==1)
            bindarr.push(obj);
          }
        }

        // alert(JSON.stringify(bindarr));
        this.insertduereportstructureService(bindarr);
        // this.FnFormpaidStructure();
        // var arr1=[];
        // var arr2=[];
        // var arr3=[];
        // var arr4=[];
        // var arr5=[];
        // for(var i=0;i<paidarr.length;i++){
        //  if(paidarr[i].installment_pattern=="1"&&paidarr[i].paymenttype_flag=="0"){
        //   arr1.push(paidarr[i]);
        //  }
        //  if(paidarr[i].installment_pattern=="3"&&paidarr[i].paymenttype_flag=="0"){
        //   arr2.push(paidarr[i]);
        //  }
        //  if(paidarr[i].installment_pattern=="4"&&paidarr[i].paymenttype_flag=="0"){
        //   arr3.push(paidarr[i]);
        //  }
        //  if(paidarr[i].installment_pattern=="1"&&paidarr[i].paymenttype_flag=="1"){
        //   arr4.push(paidarr[i]);
        //  }
        //  if(paidarr[i].installment_pattern=="3"&&paidarr[i].paymenttype_flag=="1"){
        //   arr5.push(paidarr[i]);
        //  }
        // }
 
        // var discountsplit=[];
        // for(var i=0;i<arr1.length;i++){        
        // for(var j=0;j<feesplit.length;j++)
        // {       
        // if(arr1[i].admission_no==feesplit[j].admission_no){
        // var a=[];
        // var discount=[];
        // var nameobj={"installment":""};
        // nameobj.admissionno=feesplit[j].admission_no;
        // nameobj.studentname=feesplit[j].student_name;
        // nameobj.installment=feesplit[j].installment; 
        // var o={};
        // if(feesplit[j].feetype="Annual fee"&&feesplit[j].discount_amount>0){
        // o.kitdiscount=0;
        // o.annualdiscount=feesplit[j].discount_amount;
        // o.tutiondiscount=0;
        // discount.push(o);
        // nameobj.discount=discount;
        // }
        // else if(feesplit[j].feetype="Kit fee"&&feesplit[j].discount_amount>0){
        // o.kitdiscount=feesplit[j].discount_amount;
        // o.annualdiscount=0;
        // o.tutiondiscount=0;
        // discount.push(o);
        // nameobj.discount=discount;
        // }
        // else{
        // o.kitdiscount=0;
        // o.annualdiscount=0;
        // o.tutiondiscount=0;
        // discount.push(o);
        // nameobj.discount=discount; 
        // }
        // discountsplit.push(nameobj);    
        // }
        // }
        // }
        // // alert(JSON.stringify(discountsplit));
        // for(var i=0;i<bindarr.length;i++){
        //   for(var j=0;j<discountsplit.length;j++){
        //     if(bindarr[i].admission_no==discountsplit[j].admissionno){
        //       bindarr[i].discount=discountsplit[j].discount;
        //     }
        //   }
        // }

        // alert(JSON.stringify(feesplit));
        // var split=[];
        // var splittemp=[];
        // for(var i=0;i<arr1.length;i++){        
        // for(var j=0;j<feesplit.length;j++)
        // {       
        // if(arr1[i].admission_no==feesplit[j].admission_no){
        // var a=[];
        // var discount=[];
        // var nameobj={"installment":""};
        // nameobj.admissionno=feesplit[j].admission_no;
        // nameobj.studentname=feesplit[j].student_name;
        // nameobj.installment=feesplit[j].installment; 
        // var amt=0;
        // var actamt=0;
        // var obj={"feetype":"","feetypeamount":""};
        // obj.feetype=feesplit[j].feetype;
        // obj.feetypeamount=feesplit[j].feetype_amount;
        // a.push(obj);
        // amt=feesplit[j].feetype_amount;
        // for(var k=j+1;k<feesplit.length;k++)
        // {
        //    if(feesplit[j].installment==feesplit[k].installment&&feesplit[j].admission_no==feesplit[k].admission_no)
        //    {
        //      var obj1={"feetype":"","feetypeamount":""}
        //      obj1.feetype=feesplit[k].feetype;
        //      obj1.feetypeamount=feesplit[k].feetype_amount;
        //      if(feesplit[k].feetype_amount>0)
        //      a.push(obj1);
        //      amt=parseFloat(amt)+parseFloat(feesplit[j].feetype_amount);
        //      feesplit1.splice(k,1)
        //      // splittemp.push();
        //      k--;
        //    }
        // }
        // nameobj.amount=amt;
        // nameobj.fees=a;
        // split.push(nameobj);
        // a=[];        
        // }
        // }
        // }

        // alert(JSON.stringify(split));

        // for(var i=0;i<bindarr.length;i++){
        //   for(var j=0;j<split.length;j++){
        //     if(bindarr[i].admission_no==split[j].admissionno){
        //       if(split[j].installment=="Commitment Fee"){
        //         bindarr[i].actualcommit=split[j].fees;
        //       }
        //       if(split[j].installment=="Installment1"){
        //         bindarr[i].actualins1=split[j].fees;
        //       }
        //       if(split[j].installment=="Installment2"){
        //         bindarr[i].actualins2=split[j].fees;
        //       }
        //       if(split[j].installment=="Installment3"){
        //         bindarr[i].actualins3=split[j].fees;
        //       }
        //     }
        //   }
        // }
        // alert(JSON.stringify(bindarr));
      },
      insertduereportstructureService:function(structurearr){
        count1=structurearr.length;
        for(var i=0;i<structurearr.length;i++){
        var obj={};
        this.insertduereportstructureurl=sessionStorage.getItem("addrinfo")+"/insertduereportstructure-service";
        var obj={"schoolid":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.admissionno=structurearr[i].admission_no;
        obj.studentname=structurearr[i].student_name;
        obj.grade=structurearr[i].grade;
        obj.fathername=structurearr[i].father_name;
        obj.admissionstatus=structurearr[i].admission_status;
        obj.kitfee=structurearr[i].kitfee;
        obj.annualfee=structurearr[i].annualfee;
        obj.tutionfee=structurearr[i].tutionfee;
        obj.total=structurearr[i].total; 
        this.insertduereportstructureparam=obj;
        this.$.insertduereportstructureajax.generateRequest();
        }
      },
      insertduereportstructureResponse:function(e){
        count2++;
        if(count1==count2)
        {
          alert('done!');
          count1=0;
          count2=0;
          this.FnFormpaidStructure();
        }
      },
      FnFormpaidStructure:function(){
        
        var arr1=[];
        var arr2=[];
        var arr3=[];
        var arr4=[];
        var arr5=[];
        for(var i=0;i<this.paidarr.length;i++){
         if(this.paidarr[i].installment_pattern=="1"&&this.paidarr[i].paymenttype_flag=="0"){
          arr1.push(this.paidarr[i]);
         }
         if(this.paidarr[i].installment_pattern=="3"&&this.paidarr[i].paymenttype_flag=="0"){
          arr2.push(this.paidarr[i]);
         }
         if(this.paidarr[i].installment_pattern=="4"&&this.paidarr[i].paymenttype_flag=="0"){
          arr3.push(this.paidarr[i]);
         }
         if(this.paidarr[i].installment_pattern=="1"&&this.paidarr[i].paymenttype_flag=="1"){
          arr4.push(this.paidarr[i]);
         }
         if(this.paidarr[i].installment_pattern=="3"&&this.paidarr[i].paymenttype_flag=="1"){
          arr5.push(this.paidarr[i]);
         }
        }

        var split=[];
        var commonsplit=[];
        for(var i=0;i<arr1.length;i++){        
        for(var j=0;j<this.feesplit.length;j++)
        {           
        if(arr1[i].admission_no==this.feesplit[j].admission_no){

        var commonobj={};
        commonobj.admissionno=this.feesplit[j].admission_no;
        commonobj.studentname=this.feesplit[j].student_name;
        var amt=0;
        commonobj[((this.feesplit[j].installment).replace(' ',''))+((this.feesplit[j].feetype).replace(' ',''))]=this.feesplit[j].feetype_amount;
        amt=this.feesplit[j].feetype_amount;
        for(var k=j+1;k<this.feesplit.length;k++)
        {
          if(this.feesplit[j].admission_no==this.feesplit[k].admission_no){
           commonobj[((this.feesplit[k].installment).replace(' ',''))+((this.feesplit[k].feetype).replace(' ',''))]=this.feesplit[k].feetype_amount;
           amt=parseFloat(amt)+parseFloat(this.feesplit[k].feetype_amount);
           this.feesplit.splice(k,1);
           k--;
          }
        }
        commonobj.amount=amt;
        commonsplit.push(commonobj);     
        }
        }
        }
    this.FnUpdateactualfeeService(commonsplit); 
        // alert(JSON.stringify(arr1));
        // alert(JSON.stringify(commonsplit));  
    var paidfeesarr=[];
    if(commonsplit.length>0){
    // this.FnUpdatepaidfee(commonsplit);
    for(var j=0;j<commonsplit.length;j++){    
    var paidfeesobj={};
    paidfeesobj.admissionno=commonsplit[j].admissionno;
    var flag=0;
    for(var i=0;i<arr1.length;i++){
    if(arr1[i].admission_no==commonsplit[j].admissionno){
    flag=1;
    // alert('coming');
    if(arr1[i].installment=="Commitment Fee"){
    paidfeesobj.CommitmentFeeKitfee=commonsplit[j].CommitmentFeeKitfee;
    paidfeesobj.CommitmentFeeAnnualfee=commonsplit[j].CommitmentFeeAnnualfee;
    }
    if(arr1[i].installment=="Installment1"){
    paidfeesobj.Installment1Annualfee=commonsplit[j].Installment1Annualfee;
    paidfeesobj.Installment1Tutionfee=commonsplit[j].Installment1Tutionfee;
    }
    if(arr1[i].installment=="Installment2"){
    paidfeesobj.Installment2Annualfee=commonsplit[j].Installment2Annualfee;
    paidfeesobj.Installment2Tutionfee=commonsplit[j].Installment2Tutionfee;
    }
    if(arr1[i].installment=="Installment3"){
    paidfeesobj.Installment3Annualfee=commonsplit[j].Installment3Annualfee;
    paidfeesobj.Installment3Tutionfee=commonsplit[j].Installment3Tutionfee;
    }
    arr1.splice(i,1);
    i--;
    }
    }
    if(flag==1)
    paidfeesarr.push(paidfeesobj);
    }
    }
    // alert(JSON.stringify(paidfeesarr)); 
    this.FnUpdatepaidfee(paidfeesarr);       
    },
    FnUpdateactualfeeService:function(arr){
        for(var i=0;i<arr.length;i++){
        count1=arr.length;  
        this.duereportactualfeeupdateurl=sessionStorage.getItem("addrinfo")+"/duereportactualfeeupdate-service";
        var obj={"schoolid":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.admissionno=arr[i].admissionno;
        // obj.studentname=arr[i].studentname;        
        obj.CommitmentFeeKitfee=arr[i].CommitmentFeeKitfee;
        obj.CommitmentFeeAnnualfee=arr[i].CommitmentFeeAnnualfee;
        obj.Installment1Annualfee=arr[i].Installment1Annualfee;
        obj.Installment1Tutionfee=arr[i].Installment1Tutionfee;
        obj.Installment2Annualfee=arr[i].Installment2Annualfee;
        obj.Installment2Tutionfee=arr[i].Installment2Tutionfee;
        obj.Installment3Annualfee=arr[i].Installment3Annualfee;
        obj.Installment3Tutionfee=arr[i].Installment3Tutionfee;
       
        this.duereportactualfeeupdateparam=obj;
        this.$.duereportactualfeeupdateajax.generateRequest();
        }
    },
    duereportactualfeeupdateResponse:function(e){
      count2++;
      if(count1==count2){
        alert('Updated!');
        count1=0;
        count2=0;
      }
    },
    FnUpdatepaidfee:function(arr){
        // this.admnarr=arr;
        for(var i=0;i<arr.length;i++){
        cnt1=arr.length;  
        this.duereportupdatepaidfeeurl=sessionStorage.getItem("addrinfo")+"/duereportupdatepaidfee-service";
        var obj={"schoolid":""};
        obj.schoolid=localStorage.getItem("schoolid");
        obj.admissionno=arr[i].admissionno;
        // obj.studentname=arr[i].studentname;        
        obj.CommitmentFeeKitfee=arr[i].CommitmentFeeKitfee;
        obj.CommitmentFeeAnnualfee=arr[i].CommitmentFeeAnnualfee;
        obj.Installment1Annualfee=arr[i].Installment1Annualfee;
        obj.Installment1Tutionfee=arr[i].Installment1Tutionfee;
        obj.Installment2Annualfee=arr[i].Installment2Annualfee;
        obj.Installment2Tutionfee=arr[i].Installment2Tutionfee;
        obj.Installment3Annualfee=arr[i].Installment3Annualfee;
        obj.Installment3Tutionfee=arr[i].Installment3Tutionfee;
       
        this.duereportupdatepaidfeeparam=obj;
        this.$.duereportupdatepaidfeeajax.generateRequest();
        }
    },
    duereportupdatepaidfeeResponse:function(e){
      cnt2++;
      if(cnt1==cnt2){
        alert('Updated!');
        cnt1=0;
        cnt2=0;
        this.FnduereportdueupdateService();
      }
    },
    FnduereportdueupdateService:function(){
        this.duereportdueupdateurl=sessionStorage.getItem("addrinfo")+"/duereportdueupdate-service";
        var obj={"schoolid":""};
        obj.schoolid=localStorage.getItem("schoolid");   
        this.duereportdueupdateparam=obj;
        this.$.duereportdueupdateajax.generateRequest();
    },
    duereportdueupdateResponse:function(e){
      alert(e.detail.response.returnval);
      if(e.detail.response.returnval=="Updated!")
      this.FnDuereportdiscountupdateService();
    },
    FnDuereportdiscountupdateService:function(){
        this.duereportdiscountupdateurl=sessionStorage.getItem("addrinfo")+"/duereportdiscountupdate-service";
        var obj={"schoolid":""};
        obj.schoolid=localStorage.getItem("schoolid");   
        this.duereportdiscountupdateparam=obj;
        this.$.duereportdiscountupdateajax.generateRequest();
    },
    duereportdiscountupdateResponse:function(e){
        alert(e.detail.response.returnval);
    }
    });
  })();
  </script>
</dom-module>
